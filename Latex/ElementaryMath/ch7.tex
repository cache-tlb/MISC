\chapter{微积分}

\noindent Frullani 积分

设 $f(x)$ 在 $[0,+\infty)$ 连续, $a>0, b>0$, 证明:

1. 若 $\displaystyle \lim_{x \to +\infty} f(x) = k$, 则 $\displaystyle \int_0^{+\infty}\frac{f(ax)-f(bx)}{x}\mathrm{d}x = \left(f(0) - k\right)\ln\frac{b}{a}$ ;

2. 若 $\displaystyle \int_0^{+\infty}\frac{f(x)}{x}\mathrm{d}x$ 收敛, 则 $\displaystyle \int_0^{+\infty}\frac{f(ax)-f(bx)}{x}\mathrm{d}x = f(0)\ln\frac{b}{a}$ ;

3. 若 $\displaystyle \lim_{x \to +\infty} f(x) = k$, 且 $\displaystyle \int_0^{+\infty}\frac{f(x)}{x}\mathrm{d}x$ 收敛, 则 $\displaystyle \int_0^{+\infty}\frac{f(ax)-f(bx)}{x}\mathrm{d}x = -k\ln\frac{b}{a}$.

~

\noindent 证明需要用到推广的积分第一中值定理:

若 $f$ 与 $g$ 都在 $[a,b]$ 上连续, 且 $g(x)$ 在 $[a,b]$ 上不变号, 则至少存在一点 $\xi\in[a,b]$, 使得
\[\int_a^b f(x)g(x)\ \ \mathrm{d}x = f(\xi)\int_a^b g(x)\ \mathrm{d}x .\]

~

\noindent 下面证明 Frullani 积分: 

先证第一条. 被积函数在 $0$ 和 $+\infty$ 处有奇点, 因此将积分上下限分别取极限来计算. 根据定义
\[\int_0^{+\infty}\frac{f(ax)-f(bx)}{x}\mathrm{d}x = \lim_{\substack{M\to 0^+ \\ N\to +\infty}}\int_M^N\frac{f(ax)-f(bx)}{x}\mathrm{d}x .\]

令 $ax = t, bx = u$, 积分换元有:
\begin{align*}
\int_M^N\frac{f(ax)}{x}\mathrm{d}x &= \int_{aM}^{aN}\frac{f(t)}{t}\mathrm{d}t \\
\int_M^N\frac{f(bx)}{x}\mathrm{d}x &= \int_{bM}^{bN}\frac{f(u)}{u}\mathrm{d}u
\end{align*}
于是
\begin{align*}
\int_M^N\frac{f(ax) - f(bx)}{x}\mathrm{d}x &= \int_{aM}^{bM}\frac{f(x)}{x}\mathrm{d}x + \int_{bM}^{aN}\frac{f(x)}{x}\mathrm{d}x - \int_{bM}^{aN}\frac{f(x)}{x}\mathrm{d}x - \int_{aN}^{bN}\frac{f(x)}{x}\mathrm{d}x \\
&= \int_{aM}^{bM}\frac{f(x)}{x}\mathrm{d}x - \int_{aN}^{bN}\frac{f(x)}{x}\mathrm{d}x
\end{align*}
由推广的积分第一中值定理, $g(x) = \dfrac{1}{x}$ 在 $(0,+\infty)$ 都是不变号的, 所以
\begin{align*}
\int_{aM}^{bM}\frac{f(x)}{x}\mathrm{d}x &= f(\xi_1)\int_{aM}^{bM}\frac{\mathrm{d}x}{x} = f(\xi_1)\ln\frac{b}{a}, \ \ (\xi_1\in[aM, bM]) ,\\
\int_{aN}^{bN}\frac{f(x)}{x}\mathrm{d}x &= f(\xi_2)\int_{aN}^{bN}\frac{\mathrm{d}x}{x} = f(\xi_2)\ln\frac{b}{a}, \ \ (\xi_2\in[aN, bN]) .
\end{align*}
当 $M\to 0^+, N\to+\infty$ 时, $\xi_1\to 0^+, \xi_2\to+\infty$, 于是
\begin{align*}
\int_M^N\frac{f(ax) - f(bx)}{x}\mathrm{d}x &= \lim_{\substack{M\to 0^+ \\ N\to +\infty}}\left(\int_{aM}^{bM}\frac{f(x)}{x}\mathrm{d}x  - \int_{aN}^{bN}\frac{f(x)}{x}\mathrm{d}x \right)\\
&= \lim_{\substack{\xi_1\to 0^+ \\ \xi_2\to +\infty}}(f(\xi_1) - f(\xi_2))\ln\frac{b}{a}\\
&= (f(0) - k)\ln\frac{b}{a}.
\end{align*}

后面两条同理, 但只能对一边用积分第一中值定理. 对于第二条, 
\begin{align*}
\int_M^N\frac{f(ax) - f(bx)}{x}\mathrm{d}x &= \int_{aM}^{bM}\frac{f(x)}{x}\mathrm{d}x - \int_{aN}^{bN}\frac{f(x)}{x}\mathrm{d}x \\
&= f(\xi_1)\ln\frac{b}{a} - \int_{aN}^{bN}\frac{f(x)}{x}\mathrm{d}x, \ \ (\xi_1\in[aM,bM]).
\end{align*}
由于 $\displaystyle \int_{a}^{+\infty}\frac{f(x)}{x}\mathrm{d}x$ 收敛, 故 $\displaystyle \lim_{N\to+\infty}\int_{aN}^{bN}\frac{f(x)}{x}\mathrm{d}x = 0$, 于是
\begin{align*}
\int_0^{+\infty}\frac{f(ax) - f(bx)}{x}\mathrm{d}x &= \lim_{M\to0^+}\int_{aM}^{bM}\frac{f(x)}{x}\mathrm{d}x\\
&= \lim_{\xi_1\to0^+}f(\xi_1)\ln\frac{b}{a} = f(0)\ln\frac{b}{a}.
\end{align*}

对于第三条, 
\begin{align*}
\int_M^N\frac{f(ax) - f(bx)}{x}\mathrm{d}x &= \int_{aM}^{bM}\frac{f(x)}{x}\mathrm{d}x - \int_{aN}^{bN}\frac{f(x)}{x}\mathrm{d}x \\
&= \int_{aM}^{bM}\frac{f(x)}{x}\mathrm{d}x - f(\xi_2)\ln\frac{b}{a}, \ \ (\xi_2\in[aN,bN]).
\end{align*}
由于 $\displaystyle \int_0^a\frac{f(x)}{x}\mathrm{d}x$ 收敛, 故 $\displaystyle \lim_{M\to0^+}\int_{aM}^{bM}\frac{f(x)}{x}\mathrm{d}x = 0$, 于是
\begin{align*}
\int_0^{+\infty}\frac{f(ax) - f(bx)}{x}\mathrm{d}x &= \lim_{N\to+\infty}-\int_{aN}^{bN}\frac{f(x)}{x}\mathrm{d}x \\
&= \lim_{\xi_2\to+\infty}-f(\xi_2)\ln\frac{b}{a} = -k\ln\frac{b}{a} .
\end{align*}

\newpage
%------------------------------------------------------------------------------%
\noindent 一些定积分计算

1. 计算
\[ I = \int_0^1\frac{t^\alpha - 1}{\ln t}\ \mathrm{d}t .\]

解: 设被积函数为 $f(t) = \dfrac{t^\alpha - 1}{\ln t}$, 求极限: $\displaystyle \lim_{t \to +0} f(t) = 0$, 并由洛必达法则可得 $\displaystyle \lim_{t \to 1} f(t) = \alpha$, 所以积分是存在的.

将整个积分式定义为 $\alpha$ 的函数, 设 $\displaystyle F(\alpha) = \int_0^1\frac{t^\alpha - 1}{\ln t}\ \mathrm{d}t$, 对 $\alpha$ 求导得:
\[F'(\alpha) = \int_0^1\left(\frac{e^{\alpha\ln t} - 1}{\ln t}\right)'\mathrm{d}t = \int_0^1\frac{\ln t\cdot e^{\alpha\ln t}}{\ln t}\mathrm{d}t = \int_0^1 t^\alpha\mathrm{d}t = \frac{1}{\alpha+1} .\]
所以 $F(\alpha) = \ln(\alpha+1)+C$, 由 $F(0) = 0$ 得 $C = 0$, 于是 $F(\alpha) = \ln(\alpha+1).$

另一种方法(Frullani 积分), 做变量代换 $x = -\ln t$, 则 $t = e^{-x}, \mathrm{d}t = -e^{-x}\mathrm{d}x$. 
\[ I = \int_0^1\frac{t^\alpha - 1}{\ln t}\ \mathrm{d}t = \int_{\infty}^0\frac{e^{-\alpha x} - 1}{-x}(-e^{-x})\mathrm{d}x = \int_0^{+\infty}\frac{e^{-x}-e^{-(\alpha+1)x}}{x}\mathrm{d}x\]
这里令 $f(x) = e^{-x}$, 原积分式化为
\[ I = \int_0^{+\infty}\frac{f(1\cdot x) - f((1+\alpha)x)}{x}\mathrm{d}x .\]
由 Frullani 积分可以直接得 $I = \ln(\alpha+1)$.

~

2. 证明
\[ I = \int_0^1\left(\frac{1}{1-x}+\frac{1}{\ln x}\right)\mathrm{d}x = \gamma .\]
这里 $\gamma$ 是欧拉常数: $\displaystyle \gamma = \lim_{n\to\infty}\left[(1+\frac{1}{2}+\cdots + \frac{1}{n}) - \ln n\right]$.

解: 设被积函数 $f(x) = \dfrac{1}{1-x} + \dfrac{1}{\ln x} = \dfrac{\ln x + (1 - x)}{(1-x)\ln x}$. 则 $\displaystyle \lim_{x\to0}f(x) = 1$, 并且由洛必达法则 $\displaystyle \lim_{x\to0}f(x) = \frac{1}{2}$, 所以 $f(x)$ 在 $(0,1)$ 上是可积的.

将被积函数乘以 $1-x^n$, 并令 $n\to\infty$, 得
\begin{align*}
I &= \lim_{n\to\infty}\left(\int_0^1\frac{1-x^n}{1-x} + \frac{1-x^n}{\ln x}\ \mathrm{d}x \right)\\
&= \lim_{n\to\infty}\left(\int_0^1\frac{1-x^n}{1-x}\mathrm{d}x + \int_0^1\frac{1-x^n}{\ln x}\mathrm{d}x\right) 
\end{align*}
第一项为
\[\int_0^1 = \frac{1-x^n}{1-x}\mathrm{d}x = \int_0^1(1+x+x^2+\cdots+x^{n-1})\ \mathrm{d}x = \sum_{k=1}^{n}\frac{1}{k} .\]
第二项由上一题得 
\[ \int_0^1\frac{1-x^n}{\ln x}\mathrm{d}x = -\ln(1+n) .\]
所以 
\begin{align*}
I &= \lim_{n\to\infty}\left(\sum_{k=1}^{n}\frac{1}{k} - \ln(1+n)\right) \\
&= \lim_{n\to\infty}\left(\sum_{k=1}^{n}\frac{1}{k} - \ln n + \ln n - \ln(1+n)\right) \\
&= \gamma + \lim_{n\to\infty}(\ln\frac{n}{n+1})\\
&= \gamma
\end{align*}


\newpage
%------------------------------------------------------------------------------%
\noindent 悬链线方程推导

质量均匀的绳子自由悬挂，只考虑自身重量，求形成的曲线形状。
\begin{figure*}[htbp]
\centering
\begin{tikzpicture}[scale=1.5,domain=0:5]
\coordinate (O) at (0,0);
\coordinate[label=above left:$T_0$] (A) at (-1.5,0);
\coordinate (B) at (3.2117777777777774,1.5914986998664422);
\coordinate (C) at (3.4855555555555555,1.944112448982997);
\coordinate (D) at (3.73,2.305416047938065);
\coordinate (E) at (4.67,1.944112448982997);
\draw
    pic["$\theta$",draw,line width=1pt, angle eccentricity=1.5, angle radius=0.5cm] {angle=E--C--D};

\draw[->,line width=1pt] (0.0,0) -- (6.2,0) node[right] {$x$};
\draw[->,line width=1pt] (0,-1.0) -- (0,5.2) node[above] {$y$};
\draw[color=orange,line width=1pt] plot (\x,{0.5*(exp(0.5*\x) + exp(-0.5*\x))-1}) ;

\draw [-latex,line width=1pt] (B) -- (2.27311111111111,0.4668888888889078) node[anchor=north west] {$T_2$};
\draw [-latex,line width=1pt] (D) -- (4.424222222222222,3.3708888888889077) node[anchor=north west] {$T_1$};
\draw [-latex,line width=1pt] (C) to [edge label=$\rho g \Delta s$] (3.505111111111111,0.39844444444446325);
\draw [line width=1pt,dash pattern=on 3pt off 3pt] (C) -- (E);
\draw [-latex,line width=1pt] (O) -- (A);
\foreach \p in {O,B,C,D}
	\fill[fill=black,draw=black,thick] (\p) circle (1.25pt);
\end{tikzpicture}
\end{figure*}

上图画出了一半的绳子, 另一半也是对称的. 假设绳子单位长度质量为 $ \rho $, 取其中长度为 $ \Delta s $ 的一小段绳子分析受力. 它受到重力和两端的拉力, 拉力并不是完全相反的, 假设小段绳子底部与水平方向夹角为 $ \theta $, 上端与水平方向夹角为 $ \theta + \Delta\theta $, 水平和竖直方向受力平衡分别有:
\begin{align*}
T_1\cos(\theta+\Delta\theta) &= T_2\cos\theta =\ldots=T_0,\\
T_1\sin(\theta+\Delta\theta) &= T_2\sin\theta + \rho g \Delta s .
\end{align*}
这里 $ T_0 $ 是整个绳子在最低的水平点的张力. 第二个式子中用 $ T_0 $ 替换 $ T_1, T_2 $, 并用等价无穷小, 可以得到:
\begin{align*}
\frac{\rho g}{T_0 } \Delta s &= \tan(\theta + \Delta \theta) - \tan \theta \\
 &= \tan(\Delta\theta)(1+\tan(\theta+\Delta\theta)\tan\theta) \\
 &= \Delta\theta (1 + \tan^2\theta)\\
 &= \Delta\theta \frac{1}{\cos^2\theta}%\\
%\frac{\rho g}{T_0 } \Delta s \cos\theta &= \Delta\theta \frac{1}{\cos\theta}
\end{align*}
令 $ a = \dfrac{\rho g}{T_0 } $, 并注意到 $ \Delta s \cos\theta = \Delta x $, 继续化简得到: $ a\Delta x = \dfrac{1}{\cos\theta} \Delta\theta $. 两边积分: 
\[ ax = \ln | \sec\theta + \tan\theta | + C. \]
由初值条件 $ x = 0, \theta = 0 $ 得到 $ C = 0 $, 再考虑到 $ \theta\in[0,\pi/2) $, 于是
\[ e^{ax} = \sec\theta + \tan\theta = \sqrt{1+\tan^2\theta} + \tan\theta. \]
而 $ \tan\theta = y' $, 所以
\begin{align*}
\sqrt{1+(y')^2} &= e^{ax}-y' \\
1+(y')^2 &= e^{2ax} - 2y'e^{ax} + (y')^2 \\
y' &= \frac{e^{ax}-e^{-ax}}{2} = \sinh(ax) \\
y &= \cosh(ax).
\end{align*}


\newpage
%------------------------------------------------------------------------------%

\noindent 橡皮绳上的蚂蚁

有一条橡皮绳, 初始长度为 $L$, 有一只蚂蚁在左端点, 沿着绳子向右端点爬, 速度为 $ V_1 $. 橡皮绳左端点固定, 右端点以速度 $ V_2 $ 被拉长, 绳子各处是均匀拉长的, 并且可以拉到无限长. 问蚂蚁能否爬到右端点, 如果能, 需要多长时间? 一组具体的数值: $ L = 100, V_1=V_2=1 $.

\noindent 解:

设左端点为原点, 时间为 $ t $ 时, 绳子右端点位置为 $ L + V_2 t $, 蚂蚁的位置为 $ s $. 蚂蚁的绝对速度由它的爬行速度和绳子伸长的速度叠加而来, 绳子伸长贡献的速度取决于蚂蚁当前的位置, $ s $ 与 $ t $ 的关系为:
\[
\dv{s}{t} = V_1 + V_2\cdot\frac{s}{L+V_2 t}
\]

这是一个 $ y' + P(x)y = Q(x) $ 形式的常微分方程, 可以直接套公式求. 也可以做如下的代换: $ u = \dfrac{s}{L+V_2t} $, 则 $ s = (L+V_2t)u $, 这里 $ u\in[0,1] $ 表示当前蚂蚁位置相对于绳长的比例. 于是
\begin{align*}
s &= u(L+V_2t) \\
\dd{s} &= (L+V_2t)\dd{u} + V_2u\dd{t} \\
(L+V_2t)\dv{u}{t}+V_2u &=V_1+V_2u \\
\dv{u}{t} &=\frac{V_1}{L+V_2t} \\
u &= \frac{V_1}{V_2}\ln{(L+V_2t)} + C
\end{align*}

当 $ t = 0 $ 时, $ u = 0 $, 所以 $ C = -\dfrac{V_1}{V_2}\ln(L) $. 也就是 $ u = \dfrac{V_1}{V_2}\ln{(1+\dfrac{V_2}{L}t)}$ .

代入数值, 求出 $ u = 1 $ 时的解为 $ t = \left(e^{{V_2}/{V_1}}-1\right)\dfrac{L}{V_2} = 100(e-1)$.


\newpage
%------------------------------------------------------------------------------%
\noindent 来自微博

某城市从上午开始下雪, 降雪的速度是均匀的. 市政系统中午12点整派出了除雪车清理积雪, 除雪车单位时间内清走的雪量是相等的, 并且一直往前. 从中午12点到下午1点, 除雪车前进了 1 公里, 从下午1点到下午2点, 除雪车又前进了 0.5 公里. 这期间雪一直在下. 问: 雪是从什么时候开始下的.

~

解: 注意到除雪车在某处行驶的速度与该处的积雪厚度成反比, 而积雪厚度与下雪时间成正比, 于是速度 $v$ 与时间 $t$ 成反比, 设 $v = \dfrac{c}{t}$, 派出除雪车的时刻为 $T$, 在 $(T, T+1)$ 时间内车前进的距离是在 $(T+1, T+2)$ 时间内前进距离的 2 倍, 可列出方程:
\[
\int_{T}^{T+1}{\frac{c}{t}}\ \mathrm{d}t = 2\int_{T+1}^{T+2}{\frac{c}{t}}\ \mathrm{d}t
\]
直接积分得: $\dfrac{T+1}{T} = \left(\dfrac{T+2}{T+1}\right)^2$, 解得 $T = \dfrac{\sqrt{5}-1}{2}$.

\newpage
%------------------------------------------------------------------------------%
\noindent cubemap 上每个像素对应的立体角

轴对齐的正方体中心位于原点, 边长为 2, 每个面上有一张正方形的纹理, 像素数为 $N\times N$. 相机位于原点. 考虑位于 $z=-1$ 平面上的正方形, $x,y$的范围都是 $[-1,1]$, 其上每个像素虽然面积一样, 但是所占据的视角大小不同, 例如靠近中心的像素对应的视角大于边缘像素对应的视角范围. 用立体角衡量视角的大小, 将面积元投影到以相机为球心的单位球面上, 投影面积就是立体角的大小.
\begin{figure*}[htbp]
\centering
%\tikzset{MyPersp/.style={scale=2,x={(0.95cm,-0.3122cm)}, y={(0cm,1cm)},z={(-0.95cm,-0.3122cm)}}}
%\begin{tikzpicture}[MyPersp,font=\large]
\tdplotsetmaincoords{65}{130}
\begin{tikzpicture}[scale=3.2,tdplot_main_coords]
\shade[ball color = lightgray,opacity = 0.5] (0,0,0) circle (1cm);
\draw[line width=1pt] (0,0,0) circle (1cm);
%\tdplotsphericalsurfaceplot[]{32}{16}{1}{black}{gray!1}{}{}{}%
\foreach \x in {-1,-0.75,...,1}
    \foreach \y in {-1,-0.75,...,1}
    {
        \draw[gray] (-1,\x,-1) -- (-1,\x,1);
        \draw[gray] (-1,-1,\y) -- (-1,1,\y);
    }
\begin{scope}[canvas is zx plane at y=0]
   \draw[dashed] (0,0) circle (1cm);
   \draw[dashed] (-1,0) -- (0,0);
\end{scope}
\begin{scope}[canvas is xy plane at z=0]
   \draw[dashed] (0,0) circle (1cm);
  \draw[dashed] (0,-1) -- (0,0);
\end{scope}
%\begin{scope}[canvas is zy plane at x=0]
%  \draw (0,0) circle (1cm);
%  \draw (-1,0) -- (1,0) (0,-1) -- (0,1);
%\end{scope}
\coordinate (O) at (0,0,0);
\draw[->,line width=1pt] (O)--(1.75,0,0)node[left,fill opacity=1,black]{$z$};	% old x
\draw[->,line width=1pt] (O)--(0,1.75,0)node[right,fill opacity=1,black]{$x$}; % old y
\draw[->,line width=1pt] (O)--(0,0,1.75)node[above,fill opacity=1,black]{$y$}; % old z
\draw[dashed,line width=1pt] (O)--(-1,0,0);
\fill[fill=black,draw=black,thick,fill opacity=1] (-1,0,0) circle (0.6pt);
\fill[fill=black,draw=black,thick,fill opacity=1] (0,0,0) circle (0.6pt);
\fill[fill=black,draw=black,thick,fill opacity=1] (0,0,1) circle (0.6pt);
\fill[fill=black,draw=black,thick,fill opacity=1] (0,1,0) circle (0.6pt);
\fill[fill=black,draw=black,thick,fill opacity=1] (1,0,0) circle (0.6pt);
\coordinate (P) at (-1,0.9,0.1);
\coordinate (Q) at (-0.6,0.9,0.1);
\coordinate (R) at (-0.7236,0.6512,0.0723);
\fill[fill=black,draw=black,thick,fill opacity=1] (P) circle (0.6pt);
\fill[fill=red,draw=red,thick,fill opacity=1] (R) circle (0.6pt);
\draw[dashed,red,line width=1pt] (O) -- (P)node[above right,fill opacity=1,black]{$P=(x,y,-1)$};
\draw[->,blue,line width=1pt] (P)--(Q)node[below right,fill opacity=1,blue]{$\vec{n}$};
\draw pic[draw,line width=1pt, angle eccentricity=1.8, angle radius=0.5cm] {angle=O--P--Q};
\end{tikzpicture}
\end{figure*}

设原点为 $O$, 考虑正方形上的一点 $P=(x,y,1)$, 
$P$处的面积微元为 $\mathrm{d}A = \mathrm{d}x\cdot\mathrm{d}y$, 法线方向为 $\vec{n} = (0,0,1)$, 
$P$点到原点的距离为 $R = |OP| = \sqrt{x^2+y^2+1}$, $\vec{PO}$ 方向的单位向量为 $\vec{p} = \dfrac{(x,y,1)}{R}$, 
$\mathrm{d}A$ 在 $\vec{PO}$ 方向上的投影面积为 $\mathrm{d}A\cdot\cos\angle(\vec{n},\vec{p})$, 该投影面积对应的球半径为 $R$, 所以对于 $x\in[x_1,x_2], y\in[y_1,y_2]$的一块矩形区域对应立体角为:
\[
\Omega_{[x_1,x_2]\times[y_1,y_2]} = \int_A\frac{(\vec{n}\cdot\vec{p})}{R^2} \ \mathrm{d}A = \int_A\frac{1}{R^3} \ \mathrm{d}A = \int_{y_1}^{y_2}{\int_{x_1}^{x_2}\frac{1}{(x^2+y^2+1)^{\frac{3}{2}}}\ \mathrm{d}x}\ \mathrm{d}y \ .
\]
先计算 
\[f(s,t) = \Omega_{[0,s]\times[0,t]} = \int_0^t{\int_0^s\frac{1}{(x^2+y^2+1)^{\frac{3}{2}}}\ \mathrm{d}x}\ \mathrm{d}y\ , \]
令 $u = \dfrac{x}{\sqrt{x^2+y^2+1}}$, 则积分上下限分别是 $u(x=0) = 0$, $u(x=s)=\dfrac{s}{\sqrt{s^2+y^2+1}}$, 
\[\dfrac{\mathrm{d}u}{\mathrm{d}x} = \dfrac{y^2+1}{(x^2+y^2+1)^\frac{3}{2}} ,\] 
积分换元得:
\begin{align*}
f(s,t) &= \int_0^t{\int_0^{\frac{s}{\sqrt{s^2+y^2+1}}}{\frac{1}{1+y^2}}\ \mathrm{d}u}\ \mathrm{d}y\\
&=\int_0^t{\frac{s}{(y^2+1)\sqrt{y^2+s^2+1}}}\ \mathrm{d}y . 
\end{align*}

继续换元, 令 $v = \dfrac{y}{\sqrt{y^2+s^2+1}} $, 积分上下限为 $v(y=0) = 0$, $v(y=t) = \dfrac{t}{\sqrt{s^2+t^2+1}}$, 并且
\[\frac{\mathrm{d}v}{\mathrm{d}y} = \frac{s^2+1}{(y^2+s^2+1)^\frac{3}{2}} ,\qquad y^2 + 1 = \frac{v^2s^2+1}{1-v^2} ,\qquad 1-v^2=\frac{s^2+1}{y^2+s^2+1} .\]
于是
\begin{align*}
f(s,t) &= \int_0^\frac{t}{\sqrt{s^2+t^2+1}} {\frac{s(1-v^2)}{v^2s^2+1}\cdot\frac{y^2+s^2+1}{s^2+1}}\ \mathrm{d}v \\ 
&= \int_0^\frac{t}{\sqrt{s^2+t^2+1}}{\frac{s}{s^2v^2+1}}\ \mathrm{d}v\\
&= \int_0^\frac{t}{\sqrt{s^2+t^2+1}}{\frac{1}{s}\cdot\frac{1}{v^2+\dfrac{1}{s^2}}}\ \mathrm{d}v\\
&= \frac{1}{s}\cdot s\arctan(sv)\bigg|_{v=0}^{v=\frac{t}{\sqrt{s^2+t^2+1}}}\\
&= \arctan(\frac{st}{\sqrt{s^2+t^2+1}}) .
\end{align*}

得到 $f(s,t)$ 的表达式之后, 可以用下面的方法计算其他(任意矩形)范围的立体角:
\[\Omega_{[x_1,x_2]\times[y_1,y_2]} = f(x_2,y_2) - f(x_1,y_2) - f(x_2,y_1) + f(x_1,y_1) .\]

作为验证, 考虑 cubemap 的一个面, 占据了 $\dfrac{1}{6}$ 个球面, 对应的立体角应该是 $\dfrac{2\pi}{3}$. 而
\begin{align*}
\Omega_{[-1,1]\times[-1,1]} &= f(1,1) - f(-1,1) - f(1,-1) + f(1,1) \\
& = 4\times f(1,1) \\
&= 4\times \arctan(\dfrac{1}{\sqrt{3}}) \\
& = \dfrac{2\pi}{3} .
\end{align*} 

\newpage
%------------------------------------------------------------------------------%
\noindent Shoelace Theorem

已知平面上简单多边形的顶点坐标为 $P_0, P_1, \cdots, P_{N-1}$, 求其面积.

设多边形区域为 $\Omega$, 则面积为
\[
A = \iint_\Omega {1}\ \mathrm{d}x\mathrm{d}y
\]

令 $P = 0, Q = x$, 则有 $\dfrac{\partial Q}{\partial x} - \dfrac{\partial P}{\partial y} = 1$, 根据格林公式可得
\begin{align*}
A &= \iint_\Omega {\left( \frac{\partial Q}{\partial x} - \frac{\partial P}{\partial y} \right)}\ \mathrm{d}x\mathrm{d}y \\
&= \oint_{\partial\Omega} P\mathrm{d}x + Q\mathrm{d}y\\
&= \oint_{\partial\Omega} x\mathrm{d}y \\
&= \sum_{i=0}^{N-1} \int_{P_iP_{i+1}} x\ \mathrm{d}y
\end{align*}
其中 $P_N = P_0$. 
这里用格林公式将闭区域$\Omega$上的二重积分转换成沿着区域边界 $\partial\Omega$ 上的线积分, 然后将沿着闭曲线的线积分拆成逐段积分之和.

对于多边形的每一条边$P_{i}P_{i+1}$, 参数方程为:
\[
x = (x_{i+1}-x_i)t + x_i, \ \ y = (y_{i+1}-y_i)t + y_i, \qquad t\in[0,1].
\]
于是 $x\ \mathrm{d}y = ((x_{i+1}-x_i)t+x_i)(y_{i+1}-y_i)\ \mathrm{d}t$, 
\begin{align*}
\int_{P_iP_{i+1}} x\ \mathrm{d}y &= \int_0^1 ((x_{i+1}-x_i)t+x_i)(y_{i+1}-y_i)\ \mathrm{d}t\\
&= \frac{1}{2}(x_{i+1}-x_i)(y_{i+1}-y_i) + x_i(y_{i+1}-y_i) \\
&= \frac{1}{2}(x_{i+1}+x_i)(y_{i+1}-y_i) \\
&= \frac{1}{2}(x_i y_{i+1}-x_{i+1} y_i + x_{i+1}y_{i+1}-x_i y_i)
\end{align*}

将它代入上面的求和式, 并注意到 $\displaystyle \sum_{i=0}^{N-1}x_iy_i = \sum_{i=0}^{N-1}x_{i+1}y_{i+1} $, 可得
\begin{align*}
A &= \sum_{i=0}^{N-1} \int_{P_iP_{i+1}} x\ \mathrm{d}y \\
&= \frac{1}{2}\sum_{i=0}^{N-1}{x_i y_{i+1}-x_{i+1} y_i + x_{i+1}y_{i+1}-x_i y_i}\\
&= \frac{1}{2}\left(\sum_{i=0}^{N-1} (x_i y_{i+1}-x_{i+1} y_i) + \sum_{i=0}^{N-1} x_{i+1}y_{i+1} - \sum_{i=0}^{N-1} x_i y_i\right)\\
&= \frac{1}{2}\sum_{i=0}^{N-1} (x_i y_{i+1}-x_{i+1} y_i)
\end{align*}


\newpage
%------------------------------------------------------------------------------%
\noindent Linearly Transformed Cosines 积分部分推导

用 LTC 计算多边形面光源对标准材质光照时需要计算一个积分式:
\[
\int_{P_o}{D_o(\omega_o)}\ \mathrm{d}\omega_o = \mathrm{E}(P_o) .
\]
这里 $P_o$ 表示原多边形面光源经过线性变换后的形状在单位球面上投影的区域, 因为积分变量$\omega_o$是单位向量, 所以需要将多边形的积分域投影到单位球面上. 被积函数为 $D_o(\omega_o = (x, y, z)) = \dfrac{1}{\pi}\max(0, z)$. 只要将球面上的积分域与$z^+$半球求交集, 作为新的积分域, 就可以将 $D_o$ 中的 $\max$ 函数去掉了. 这个积分有解析表达式, 原论文中没有给出推导, 而是直接给出结论:
\[
\mathrm{E}(p_1,\cdots,p_n) = \frac{1}{2\pi}\sum_{i=1}^{n}{\arccos( \langle p_i,p_j \rangle) \langle  \frac{p_i\times p_j}{||p_i\times p_j||}, [0,0,1]^T\rangle}
\]
其中 $p_1, \cdots, p_n$ 为多边形的各顶点在单位球面上投影的坐标, $j=(i+1)\ \mathrm{mod}\ n$, $\langle p_i, p_j \rangle$ 表示 $p_i$ 与 $p_j$ 的内积,  $p_i \times p_j$ 表示 $p_i$ 与 $p_j$ 的外积.

如何推导呢?

用球面坐标$(\theta,\phi)$表示球面上的点. 
\begin{align*}
x &= \cos\theta\sin\phi \\
y &= \sin\theta\sin\phi \\
z &= \cos\phi
\end{align*}
分别求微分得到:
\begin{align*}
\mathrm{d}x &= -\sin\theta\sin\phi\ \mathrm{d}\theta + \cos\theta\cos\phi\ \mathrm{d}\phi \\
\mathrm{d}y &= \cos\theta\sin\phi\ \mathrm{d}\theta + \sin\theta\cos\phi\ \mathrm{d}\phi\\
\mathrm{d}z &= -\sin\phi\ \mathrm{d}\phi
\end{align*}
将 $\mathrm{d}x$ 和 $\mathrm{d}y$ 的表达式分别乘以 $-\sin\theta$ 和 $\cos\theta$ 并相加, 得:
\[
\cos\theta\ \mathrm{d}y - \sin\theta\ \mathrm{d}x = \sin\phi\ \mathrm{d}\theta \qquad\cdots\qquad (1)
\]

回到原积分问题, 要求的是 
\begin{align*}
\mathrm{E}(P_o) &= \int_{P_o}{D_o(\omega_o)}\ \mathrm{d}\omega_o = \iint_{P_o}{\frac{1}{\pi}\cdot z\ \sin\phi\ \mathrm{d}\phi\mathrm{d}\theta}\\
2\pi\cdot\mathrm{E}(P_o) &= \iint_{P_o}2\ \cos\phi\ \sin\phi\ \mathrm{d}\phi\mathrm{d}\theta = \iint_{P_o}\sin{2\phi}\ \mathrm{d}\phi\mathrm{d}\theta
\end{align*}
令 
\[
P = \frac{1}{2}(1-\cos{2\phi}) = \sin^2\phi, \qquad Q = 0
\]
则
\[
\frac{\partial P}{\partial\phi} - \frac{\partial Q}{\partial\theta} = \sin{2\phi}
\]
根据格林公式有
\begin{align*}
I = 2\pi\cdot\mathrm{E}(P_o) &= \iint_{P_o}\sin{2\phi}\ \mathrm{d}\phi\mathrm{d}\theta = \iint_{P_o}\left(\frac{\partial P}{\partial\phi} - \frac{\partial Q}{\partial\theta}\right)\ \mathrm{d}\phi\mathrm{d}\theta \\
&= \oint_{\partial P_o} \left(P\ \mathrm{d}\theta + Q\ \mathrm{d}\phi \right) = \oint_{\partial P_o} {\sin^2\phi}\ \mathrm{d}\theta
\end{align*}
这里 $\partial P_o$ 表示球面上多边形投影区域$P_o$的边界. 由 (1) 式可进一步得到:
\[
I = \oint_{\partial P_o}\sin\phi(\cos\theta\ \mathrm{d}y - \sin\theta\ \mathrm{d}x) = \oint_{\partial P_o}x\ \mathrm{d}y - y\ \mathrm{d}x = \sum_{i=1}^{n}\int_{\overset{\frown}{p_ip_j}} x\ \mathrm{d}y - y\ \mathrm{d}x
\]
沿着闭曲线的积分被拆成了逐段曲线积分, 每一段积分的路径 $\overset{\frown}{p_ip_j}$ 表示 $p_i$ 和 $p_j$ 所在的大圆上从$p_i$ 到 $p_j$ 的一段圆弧, 其中 $j = (i+1)\ \mathrm{mod}\ n$.

为了计算这一系列的曲线积分, 考虑每一段的参数方程, 由球面插值函数 slerp 可以得到第 $i$ 段曲线的参数方程为:
\[
f_i(t) = a_i(t) p_i + b_i(t) p_j = \frac{\sin (1-t)\alpha_i}{\sin\alpha_i} p_i + \frac{\sin t\alpha_i}{\sin\alpha_i} p_j
\]
其中 $\alpha_i = \arccos(\langle p_i,p_j \rangle)$ 为 $p_i$ 与 $p_j$ 之间的夹角, 或$p_i$ 到 $p_j$ 的大圆弧的圆心角. 在曲线 $\overset{\frown}{p_ip_j}$ 上, 有
\begin{align*}
x\ \mathrm{d}y - y\ \mathrm{d}x &= (a_ix_i+b_ix_j)(a'_iy_i+b'_iy_j)\mathrm{d}t - (a_iy_i+b_iy_j)(a'_ix_i+b'_ix_j)\mathrm{d}t\\
&= (a_ib'_i - a'_ib_i)(x_iy_j - y_ix_j)\mathrm{d}t
\end{align*}
这里$(x_i,y_i,z_i)=p_i, (x_j,y_j,z_j)=p_j$ 为常数, $a_i, a'_i, b_i, b'_i$ 为$t$ 的函数, 而
\begin{align*}
a'_i(t) &= \frac{1}{\sin\alpha_i}\cos(1-t)\alpha_i\cdot(-\alpha_i) \\
b'_i(t) &= \frac{1}{\sin\alpha_i}\cos t\alpha_i \cdot \alpha_i
\end{align*}
于是
\begin{align*}
a_ib'_i - a'_ib_i &= \frac{\alpha_i}{\sin^2\alpha_i}\left(\sin(1-t)\alpha_i\cdot\cos t\alpha_i + \cos(1-t)\alpha_i\cdot\sin t\alpha_i\right)\\
&= \frac{\alpha_i}{\sin^2\alpha_i}\sin((1-t)\alpha_i + t\alpha_i)\\
&= \frac{\alpha_i}{\sin\alpha_i}
\end{align*}
参数 $t$ 被消去了. 这样每段曲线积分的结果就是
\begin{align*}
I_i &= \int_{\overset{\frown}{p_ip_j}} x\ \mathrm{d}y - y\ \mathrm{d}x \\
&= \int_0^1(a_ib'_i - a'_ib_i)(x_iy_j - y_ix_j)\ \mathrm{d}t \\
&= \int_0^1 \frac{\alpha_i}{\sin\alpha_i}(x_iy_j - y_ix_j)\ \mathrm{d}t\\
 &= \frac{\alpha_i}{\sin\alpha_i}(x_iy_j - y_ix_j)
\end{align*}
注意到 $||p_i\times p_j|| = \sin\alpha_i$, 而 $x_iy_j - y_ix_j$ 正好是 $p_i\times p_j$ 的$z$分量, 于是
\[
I_i = \frac{\arccos(\langle p_i,p_j \rangle)}{||p_i\times p_j||}\langle p_i\times p_j,[0,0,1]^T \rangle
\]
所求积分为 
\[
\mathrm{E}(P_o) = \frac{1}{2\pi}I = \frac{1}{2\pi}\sum_{i=1}^n \frac{\arccos(\langle p_i,p_j \rangle)}{||p_i\times p_j||}\langle p_i\times p_j,[0,0,1]^T \rangle
\]

\newpage
%------------------------------------------------------------------------------%
\noindent Tube light 的 irradiance 计算

Tube light 是一条只有长度, 没有粗细的线段, 线段上每一处都相当于一个点光源, 满足平方反比衰减, 线段两端点相对于着色点的坐标分别为 $\bold{L}_0, \bold{L}_1$, 着色点的法线为 $\bold{n}$, 则着色点的 irradiance 为:
\[I = \int_{\bold{L}_0}^{\bold{L}_1}\frac{\langle \bold{n},\bold{L} \rangle}{|\bold{L}|^3}\ \mathrm{d}\bold{L} = \frac{\dfrac{\langle\bold{n},\bold{L}_1\rangle}{|\bold{L}_1|}+\dfrac{\langle\bold{n},\bold{L}_0\rangle}{|\bold{L}_0|} }{\langle\bold{L}_0,\bold{L}_1\rangle + |\bold{L}_0|\cdot|\bold{L}_1|}\]

设$\bold{v} = \bold{L}_1 - \bold{L}_0$, 则线段的参数方程为 
\[
\bold{L}(t) = \bold{L}_0 + t\bold{v}.
\]
于是积分式变换为:
\begin{align*}
I &= \int_{\bold{L}_0}^{\bold{L}_1}\frac{\langle \bold{n},\bold{L} \rangle}{|\bold{L}|^3}\ \mathrm{d}\bold{L} \\
&= \int_0^1\frac{\langle \bold{n}, \bold{L}_0+t\bold{v} \rangle}{(\langle \bold{L}_0+t\bold{v},\bold{L}_0+t\bold{v}\rangle)^{\frac{3}{2}}}\ \mathrm{d}t \\
&= \int_0^1\frac{\langle\bold{n},\bold{L}_0\rangle + \langle\bold{n},\bold{v}\rangle\cdot t}{\sqrt{\langle\bold{v},\bold{v}\rangle\cdot t^2 + 2\langle\bold{L}_0,\bold{v}\rangle\cdot t + \langle\bold{L}_0,\bold{L}_0\rangle}^3}\ \mathrm{d}t \\
&= \int_0^1\frac{Dt+E}{\sqrt{At^2+Bt+C}^3}\ \mathrm{d}t \\
&= \frac{2(D(Bt+2C) - E(2At+B))}{(B^2-4AC)\sqrt{At^2+Bt+C}}\bigg|_0^1\\
&= \frac{2}{B^2-4AC}\left(\frac{D(B + 2C) - E(2A+B)}{\sqrt{A+B+C}} - \frac{2CD - BE}{\sqrt{C}}\right)
\end{align*}
其中
\[
A = \langle\bold{v},\bold{v}\rangle, \quad
B = 2\langle\bold{L}_0,\bold{v}\rangle, \quad
C = \langle\bold{L}_0,\bold{L}_0\rangle, \quad
D = \langle\bold{n},\bold{v}\rangle,\quad 
E = \langle\bold{n},\bold{L}_0\rangle
\]
这里省去了求原函数的推导, 可以验证原函数确实是正确的. 进一步计算:
\begin{align*}
\sqrt{A+B+C} &= \sqrt{\langle\bold{L}_0+\bold{v},\bold{L}_0+\bold{v}\rangle} = |\bold{L}_1| \\
\sqrt{C} &= |\bold{L}_0|\\
B^2-4AC &= 4(\langle\bold{L}_0,\bold{L}_1\rangle-\langle\bold{L}_0,\bold{L}_0\rangle)^2 - 4\langle\bold{L}_1-\bold{L}_0,\bold{L}_1-\bold{L}_0\rangle\cdot\langle\bold{L}_0,\bold{L}_0\rangle \\
&= 4(\langle\bold{L}_0,\bold{L}_1\rangle^2 - \langle\bold{L}_0,\bold{L}_0\rangle\cdot\langle\bold{L}_1,\bold{L}_1\rangle)\\
2CD-BE &= 2\langle\bold{L}_0,\bold{L}_0 \rangle\cdot\langle\bold{n},\bold{L}_1-\bold{L}_0\rangle - 2\langle\bold{n},\bold{L}_0 \rangle\cdot\langle\bold{L}_0,\bold{L}_1-\bold{L}_0\rangle\\
&= 2(\langle\bold{L}_0,\bold{L}_0 \rangle\cdot\langle\bold{n},\bold{L}_1\rangle - \langle\bold{L}_0,\bold{L}_1 \rangle\cdot\langle\bold{n},\bold{L}_0\rangle) \\
B+2C &= 2\langle\bold{L}_0,\bold{v}\rangle + 2\langle\bold{L}_0,\bold{L}_0\rangle = 2\langle\bold{L}_0,\bold{L}_1\rangle \\
2A+B &= 2\langle\bold{v},\bold{v}\rangle + 2\langle\bold{L}_0,\bold{v}\rangle = 2\langle\bold{L}_1,\bold{L}_1 - \bold{L}_0\rangle
\end{align*}
\begin{align*}
D(B+2C)-E(2A+B) &= 2\langle\bold{n},\bold{L}_1-\bold{L}_0\rangle \cdot \langle\bold{L}_0,\bold{L}_1\rangle - 2\langle\bold{n},\bold{L}_0\rangle\cdot\langle\bold{L}_1,\bold{L}_1 - \bold{L}_0\rangle\\
&= 2(\langle\bold{n},\bold{L}_1\rangle\cdot\langle\bold{L}_0,\bold{L}_1\rangle - \langle\bold{n},\bold{L}_0\rangle\cdot\langle\bold{L}_1,\bold{L}_1\rangle)
\end{align*}
代入前面的式子:
\begin{align*}
I &= \frac{2}{B^2-4AC}\left(\frac{D(B + 2C) - E(2A+B)}{\sqrt{A+B+C}} - \frac{2CD - BE}{\sqrt{C}}\right)\\
&= \frac{ \dfrac{\langle\bold{n},\bold{L}_1\rangle\cdot\langle\bold{L}_0,\bold{L}_1\rangle - \langle\bold{n},\bold{L}_0\rangle\cdot|\bold{L}_1|^2}{|\bold{L}_1|} - \dfrac{|\bold{L}_0|^2\cdot\langle\bold{n},\bold{L}_1\rangle - \langle\bold{L}_0,\bold{L}_1\rangle\cdot\langle\bold{n},\bold{L}_0\rangle}{|\bold{L}_0|} }{\langle\bold{L}_0,\bold{L}_1\rangle^2-|\bold{L}_0|^2\cdot|\bold{L}_1|^2}\\
&= \frac{  \dfrac{\langle\bold{n},\bold{L}_1\rangle\cdot\langle\bold{L}_0,\bold{L}_1\rangle}{|\bold{L}_1|} + \dfrac{\langle\bold{n},\bold{L}_0\rangle\cdot\langle\bold{L}_0,\bold{L}_1\rangle}{\bold{L}_0} - \langle\bold{n},\bold{L}_0\rangle\cdot|\bold{L}_1| - \langle\bold{n},\bold{L}_1\rangle\cdot|\bold{L}_0|}{(\langle\bold{L}_0,\bold{L}_1\rangle+|\bold{L}_0|\cdot|\bold{L}_1|)(\langle\bold{L}_0,\bold{L}_1\rangle-|\bold{L}_0|\cdot|\bold{L}_1|)} \\
&= \frac{\langle\bold{L}_0,\bold{L}_1\rangle\left(\dfrac{\langle\bold{n},\bold{L}_1\rangle}{|\bold{L}_1|}+\dfrac{\langle\bold{n},\bold{L}_0\rangle}{|\bold{L}_0|}\right) - |\bold{L}_0|\cdot|\bold{L}_1|\left(\dfrac{\langle\bold{n},\bold{L}_0\rangle}{|\bold{L}_0|}+\dfrac{\langle\bold{n},\bold{L}_1\rangle}{|\bold{L}_1|}\right)}{(\langle\bold{L}_0,\bold{L}_1\rangle+|\bold{L}_0|\cdot|\bold{L}_1|)(\langle\bold{L}_0,\bold{L}_1\rangle-|\bold{L}_0|\cdot|\bold{L}_1|)} \\
&= \frac{\dfrac{\langle\bold{n},\bold{L}_1\rangle}{|\bold{L}_1|}+\dfrac{\langle\bold{n},\bold{L}_0\rangle}{|\bold{L}_0|} }{\langle\bold{L}_0,\bold{L}_1\rangle + |\bold{L}_0|\cdot|\bold{L}_1|}
\end{align*}









